<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders Â· Modern Garden</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #f1f7f2;
            font-family: 'Inter', sans-serif;
            color: #1f2e1f;
        }
        /* navbar */
        .navbar {
            background: #1a3b2e;
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 20px rgba(0,40,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
            color: white;
        }
        .logo-icon {
            width: 48px; height: 48px;
            background: #4caf7a;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #1a3b2e;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .logo-text h1 {
            font-family: 'Playfair Display', serif;
            font-size: 26px;
            font-weight: 700;
            line-height: 1.1;
            color: white;
            letter-spacing: -0.5px;
        }
        .logo-text span {
            font-size: 11px;
            letter-spacing: 2px;
            color: #b7e0c0;
            font-weight: 400;
        }
        .nav-links { display: flex; gap: 8px; }
        .nav-link {
            color: #e0f0e5;
            text-decoration: none;
            padding: 8px 18px;
            border-radius: 30px;
            font-weight: 500;
            transition: 0.2s;
        }
        .nav-link:hover { background: #2d5a47; color: white; }
        .nav-link.active { background: #4caf7a; color: #1a3b2e; font-weight: 600; }

        /* main container */
        .container { max-width: 1000px; margin: 40px auto; padding: 0 24px; }
        .page-header { margin-bottom: 30px; }
        .page-title {
            font-family: 'Playfair Display', serif;
            font-size: 38px;
            color: #1a3b2e;
            font-weight: 700;
            letter-spacing: -0.5px;
            position: relative;
            display: inline-block;
        }
        .page-title:after {
            content: '';
            position: absolute;
            bottom: -8px; left: 0;
            width: 60px; height: 4px;
            background: #4caf7a;
            border-radius: 4px;
        }
        .order-grid { display: flex; flex-direction: column; gap: 28px; }

        /* order card */
        .order-card {
            background: #ffffffec;
            backdrop-filter: blur(2px);
            border-radius: 28px;
            box-shadow: 0 12px 30px -8px rgba(30,60,30,0.12);
            overflow: hidden;
            border: 1px solid rgba(100,160,120,0.2);
            transition: all 0.25s ease;
        }
        .order-card:hover {
            box-shadow: 0 20px 35px -6px #2b5a3b40;
            transform: scale(1.01);
        }
        .order-header {
            padding: 20px 30px;
            background: linear-gradient(95deg, #f8fffa, #f0f9f0);
            border-bottom: 1px solid #cdedd6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .order-id-badge {
            background: #1a3b2e;
            color: white;
            padding: 6px 16px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.3px;
            box-shadow: 0 3px 8px rgba(0,30,0,0.2);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .status-badge {
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-processing { background: #fff1cf; color: #b45b0a; border-left: 5px solid #f90; }
        .status-shipped { background: #d5ecff; color: #0a5b8c; border-left: 5px solid #1976d2; }
        .status-delivered { background: #d9f0da; color: #1f6d2f; border-left: 5px solid #2e7d32; }

        .order-body { padding: 28px 30px; }
        .order-meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px,1fr));
            gap: 16px;
            background: #f3faf5;
            padding: 18px 20px;
            border-radius: 22px;
            margin-bottom: 24px;
            border: 1px dashed #9fd3aa;
        }
        .meta-item span { font-size: 12px; color: #4d6b55; letter-spacing: 0.3px; }
        .meta-item strong { font-size: 1.1rem; color: #1a3b2e; font-weight: 700; }

        /* Tracking status timeline */
        .tracking-timeline {
            background: #e9f4ec;
            border-radius: 20px;
            padding: 20px 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }
        .track-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-width: 70px;
            position: relative;
            flex: 1;
        }
        .track-step .step-icon {
            width: 40px; height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a3b2e;
            border: 2px solid #8fc0a9;
            margin-bottom: 6px;
            font-size: 1.2rem;
        }
        .track-step.completed .step-icon {
            background: #1a3b2e;
            color: white;
            border-color: #1a3b2e;
        }
        .track-step.active .step-icon {
            border-color: #f90;
            background: #fff3e0;
            color: #b45b0a;
            border-width: 3px;
        }
        .step-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #3c6147;
        }
        .step-date {
            font-size: 0.65rem;
            color: #3f6b4c;
            font-weight: 500;
        }

        .product-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 0;
            border-bottom: 1px solid #e1f0e4;
        }
        .product-row:last-child { border-bottom: none; }
        .prod-img {
            width: 64px; height: 64px; border-radius: 16px;
            object-fit: cover;
            border: 2px solid #c0e0c0;
            box-shadow: 0 4px 8px rgba(0,30,0,0.1);
        }
        .prod-info { flex: 1; }
        .prod-name { font-weight: 700; font-size: 1rem; color: #1a3b2e; }
        .prod-meta { font-size: 0.85rem; color: #4b7256; }
        .prod-price { font-weight: 800; color: #1a3b2e; background: #e3f1e6; padding: 5px 12px; border-radius: 30px; }

        .order-footer-actions {
            margin-top: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        .btn {
            padding: 12px 28px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: white;
            border: 1px solid #b0d0b0;
            color: #1f3b2a;
        }
        .btn:hover { background: #ebf9eb; }
        .btn-primary {
            background: #1a3b2e;
            border: none;
            color: white;
            box-shadow: 0 8px 14px -8px #1a3b2e;
        }
        .btn-primary:hover { background: #2d6a4a; transform: translateY(-2px); }

        /* MODAL â€“ scrollable */
        .modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(30, 50, 30, 0.5);
            backdrop-filter: blur(6px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        .invoice-card {
            max-width: 560px;
            width: 100%;
            margin: 30px auto;
            background: white;
            border-radius: 32px;
            box-shadow: 0 30px 60px rgba(10,40,10,0.4);
            overflow: hidden;
            animation: floatIn 0.3s;
        }
        @keyframes floatIn { 0%{opacity:0; transform:scale(0.96);} 100%{opacity:1;} }

        .inv-head-garden {
            background: linear-gradient(135deg, #1a3b2e, #2f7654);
            padding: 28px 28px 20px 28px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .inv-brand {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .inv-brand i { font-size: 36px; color: #d4ffb0; }
        .inv-brand-text h2 { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 700; margin:0; }
        .inv-brand-text span { opacity:0.9; font-size: 10px; letter-spacing: 2px; }
        .inv-qr-block {
            background: white; padding: 8px; border-radius: 18px;
            display: flex; flex-direction: column; align-items: center;
        }

        .inv-body { padding: 32px 30px; }
        .inv-title-section {
            display: flex; justify-content: space-between; align-items: baseline;
            border-bottom: 2px solid #d5eeda; padding-bottom: 16px; margin-bottom: 20px;
        }
        .inv-title-section h1 { font-size: 32px; color: #1f402a; font-weight: 300; letter-spacing: -0.5px; }
        .inv-badge { background: #d0ecd2; color: #1a3b2e; padding: 6px 14px; border-radius: 30px; font-weight: 700; }

        .two-col {
            display: flex; gap: 25px; margin: 20px 0 25px;
            background: #f7fff9; padding: 20px; border-radius: 24px;
        }
        .col-bill h4 { font-size: 11px; color: #5e8b6f; letter-spacing: 1px; margin-bottom: 8px; }
        .col-bill p { font-size: 14px; font-weight: 500; color: #1e3d2a; margin: 3px 0; }

        .delivery-chip {
            background: #e7f6e9;
            border: 1px solid #52b87a;
            padding: 14px 20px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0 25px;
        }
        .delivery-chip i { color: #1d7542; font-size: 20px; }
        .delivery-chip span { font-weight: 700; color: #1a3b2e; font-size: 1rem; }

        .inv-table-mini {
            width: 100%; border-collapse: collapse; margin: 18px 0;
        }
        .inv-table-mini th { font-size: 11px; color: #6c9176; text-transform: uppercase; padding-bottom: 10px; border-bottom: 1px solid #b7dac1; }
        .inv-table-mini td { padding: 12px 4px; border-bottom: 1px solid #e3f0e5; }
        .inv-table-mini td:last-child { text-align: right; font-weight: 600; }

        .invoice-total-card {
            background: #f2fbf4; padding: 18px; border-radius: 20px; width: fit-content; margin-left: auto; margin-top: 10px;
        }
        .total-row { display: flex; gap: 40px; justify-content: space-between; font-size: 1rem; padding: 6px 0; }
        .grand-total { border-top: 2px solid #1a3b2e; margin-top: 10px; padding-top: 12px; font-weight: 800; color: #1a3b2e; }

        .inv-footer-note {
            background: #f5fcf6; padding: 22px; border-radius: 20px; margin-top: 20px; font-size: 12px; color: #395e45;
            display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;
        }
        .toast-message {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(80px);
            background: #1f3e2b; color: white; padding: 14px 34px; border-radius: 50px;
            font-weight: 500; box-shadow: 0 10px 25px rgba(0,20,0,0.3); transition: 0.3s; opacity: 0; z-index: 2000;
        }
        .toast-message.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="#" class="logo">
        <div class="logo-icon"><i class="fas fa-seedling"></i></div>
        <div class="logo-text">
            <h1>Modern Garden</h1>
            <span>HEIRLOOM & ORGANIC</span>
        </div>
    </a>
    <div class="nav-links">
        <a href="#" class="nav-link">Shop</a>
        <a href="#" class="nav-link active">Orders</a>
        <a href="#" class="nav-link">Cart</a>
    </div>
</nav>

<div class="container">
    <div class="page-header">
        <h2 class="page-title">My plant orders</h2>
        <p style="color: #3a624a; margin-top: 12px;">Track status, reorder or download invoice</p>
    </div>
    <div id="orderList" class="order-grid"></div>
</div>

<!-- Invoice modal (scrollable via .modal overflow) -->
<div id="invoiceModal" class="modal">
    <div class="invoice-card" id="invoiceContent"></div>
</div>

<div id="toast" class="toast-message">âœ¨ updated</div>

<script>
    // Make functions globally available
    let globalOrders = [];

    // ensure jsPDF
    const { jsPDF } = window.jspdf || {};

    // ----- SAMPLE ORDERS with tracking details -----
    const defaultOrders = [
        {
            id: 'MG2204A',
            date: '12/04/2025',
            customer: 'John Doe',
            address: '45, Hibiscus Street, Greenfield 400067',
            mobile: '+91 98765 43210',
            method: 'Credit Card',
            status: 'Processing',
            tracking: {
                placed: '12/04/2025',
                processed: '13/04/2025',
                shipped: null,
                outForDelivery: null,
                delivered: null
            },
            items: [
                { id: 101, name: 'Monstera Deliciosa', price: 120, quantity: 2, image: 'https://images.unsplash.com/photo-1614594975525-e45190c55d0b?w=80&h=80&fit=crop' },
                { id: 102, name: 'Snake Plant', price: 65, quantity: 1, image: 'https://images.unsplash.com/photo-1593691509543-c55fb32d8de5?w=80&h=80&fit=crop' },
                { id: 103, name: 'Organic Basil Seeds', price: 40, quantity: 3, image: 'https://images.unsplash.com/photo-1596283379431-43c8b6b4f978?w=80&h=80&fit=crop' }
            ],
            total: 120*2 + 65 + 40*3
        },
        {
            id: 'MG2219K',
            date: '02/05/2025',
            customer: 'Jane Miller',
            address: 'Flat 202, Palm Grove, Bangalore 560078',
            mobile: '+91 99887 66554',
            method: 'PayPal',
            status: 'Shipped',
            tracking: {
                placed: '02/05/2025',
                processed: '03/05/2025',
                shipped: '05/05/2025',
                outForDelivery: null,
                delivered: null
            },
            items: [
                { id: 201, name: 'Lavender Plant', price: 90, quantity: 2, image: 'https://images.unsplash.com/photo-1597843786279-43e6b5c289e1?w=80&h=80&fit=crop' },
                { id: 202, name: 'Cherry Tomato Seeds', price: 55, quantity: 1, image: 'https://images.unsplash.com/photo-1595348020946-82d8a9c6c6db?w=80&h=80&fit=crop' }
            ],
            total: 90*2 + 55
        },
        {
            id: 'MG2301B',
            date: '15/02/2025',
            customer: 'Ravi Kapoor',
            address: '8/2, Garden Avenue, Delhi 110021',
            mobile: '+91 98760 12345',
            method: 'UPI',
            status: 'Delivered',
            tracking: {
                placed: '15/02/2025',
                processed: '16/02/2025',
                shipped: '18/02/2025',
                outForDelivery: '20/02/2025',
                delivered: '20/02/2025'
            },
            items: [
                { id: 301, name: 'Peace Lily', price: 150, quantity: 1, image: 'https://images.unsplash.com/photo-1593691509543-c55fb32d8de5?w=80&h=80&fit=crop' },
                { id: 302, name: 'Mint Plant', price: 35, quantity: 4, image: 'https://images.unsplash.com/photo-1618832337140-2f8350d6cdb3?w=80&h=80&fit=crop' }
            ],
            total: 150 + 35*4
        }
    ];

    if (!localStorage.getItem('orders')) {
        localStorage.setItem('orders', JSON.stringify(defaultOrders));
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2800);
    }

    // ----- render orders with tracking timeline -----
    function renderOrders() {
        const orders = JSON.parse(localStorage.getItem('orders')) || [];
        globalOrders = orders;
        const container = document.getElementById('orderList');
        container.innerHTML = '';

        orders.forEach(order => {
            let statusClass = 'status-processing';
            if (order.status === 'Shipped') statusClass = 'status-shipped';
            else if (order.status === 'Delivered') statusClass = 'status-delivered';

            // Build tracking steps based on status & tracking object
            const track = order.tracking || { placed: order.date, processed: '', shipped: '', outForDelivery: '', delivered: '' };
            const steps = [
                { label: 'Placed', key: 'placed', date: track.placed || order.date },
                { label: 'Processed', key: 'processed', date: track.processed },
                { label: 'Shipped', key: 'shipped', date: track.shipped },
                { label: 'Out for delivery', key: 'outForDelivery', date: track.outForDelivery },
                { label: 'Delivered', key: 'delivered', date: track.delivered }
            ];

            let completedUntil = 0;
            if (order.status === 'Processing') completedUntil = 1;
            else if (order.status === 'Shipped') completedUntil = 3;
            else if (order.status === 'Delivered') completedUntil = 5;

            const timelineHtml = steps.map((step, idx) => {
                let stepClass = '';
                if (idx < completedUntil) stepClass = 'completed';
                else if (idx === completedUntil && order.status !== 'Delivered') stepClass = 'active';
                const dateDisplay = step.date ? step.date : 'â€”';
                return `<div class="track-step ${stepClass}">
                    <div class="step-icon"><i class="fas ${idx === 0 ? 'fa-check-circle' : (idx === 4 ? 'fa-home' : 'fa-truck')}"></i></div>
                    <span class="step-label">${step.label}</span>
                    <span class="step-date">${dateDisplay}</span>
                </div>`;
            }).join('');

            const productsHtml = order.items.map(item => `
                <div class="product-row">
                    <img src="${item.image}" class="prod-img" alt="${item.name}" loading="lazy">
                    <div class="prod-info">
                        <div class="prod-name">${item.name}</div>
                        <div class="prod-meta">Qty: ${item.quantity} Ã— â‚¹${item.price}</div>
                    </div>
                    <div class="prod-price">â‚¹${item.price * item.quantity}</div>
                </div>
            `).join('');

            const card = document.createElement('div');
            card.className = 'order-card';
            card.innerHTML = `
                <div class="order-header">
                    <span class="order-id-badge"><i class="fas fa-receipt"></i> Order #${order.id}</span>
                    <span class="status-badge ${statusClass}">${order.status}</span>
                </div>
                <div class="order-body">
                    <div class="order-meta-grid">
                        <div class="meta-item"><span>ðŸ“… Date</span><strong>${order.date}</strong></div>
                        <div class="meta-item"><span>ðŸ’° Total</span><strong>â‚¹${order.total}</strong></div>
                        <div class="meta-item"><span>ðŸ’³ Payment</span><strong>${order.method}</strong></div>
                        <div class="meta-item"><span>ðŸ“¦ Items</span><strong>${order.items.length}</strong></div>
                    </div>

                    <!-- TRACKING TIMELINE -->
                    <div class="tracking-timeline">
                        ${timelineHtml}
                    </div>

                    ${productsHtml}
                    <div class="order-footer-actions">
                        <div style="font-size:0.9rem;color:#4f735a;"><i class="fas fa-truck"></i> Live tracking</div>
                        <div style="display:flex; gap:12px;">
                            <button class="btn" onclick="reorderItems('${order.id}')"><i class="fas fa-copy"></i> Reorder</button>
                            <button class="btn btn-primary" onclick="openInvoice('${order.id}')"><i class="fas fa-file-invoice"></i> View invoice</button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // ----- reorder -----
    window.reorderItems = function(orderId) {
        const orders = JSON.parse(localStorage.getItem('orders'));
        const order = orders.find(o => o.id === orderId);
        if (!order) return;
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        order.items.forEach(incoming => {
            const exists = cart.find(c => c.id === incoming.id);
            if (exists) exists.quantity += incoming.quantity;
            else cart.push({ ...incoming });
        });
        localStorage.setItem('cart', JSON.stringify(cart));
        showToast(`ðŸ›’ Items from #${orderId} added to cart`);
    };

    // ----- open invoice modal -----
    window.openInvoice = function(orderId) {
        const orders = JSON.parse(localStorage.getItem('orders'));
        const order = orders.find(o => o.id === orderId);
        if (!order) return;

        const subtotal = order.items.reduce((a, i) => a + (i.price * i.quantity), 0);
        const tax = Math.round(subtotal * 0.12);
        const grandTotal = subtotal + tax;

        const parts = order.date.split('/');
        const rawDate = new Date(`${parts[1]}/${parts[0]}/${parts[2]}`);
        rawDate.setDate(rawDate.getDate() + 5);
        const deliveryStr = rawDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });

        const modalContent = document.getElementById('invoiceContent');
        modalContent.innerHTML = `
            <div class="inv-head-garden">
                <div class="inv-brand">
                    <i class="fas fa-tree"></i>
                    <div class="inv-brand-text">
                        <h2>Modern Garden</h2>
                        <span>EST. 2020 Â· HEIRLOOM</span>
                    </div>
                </div>
                <div class="inv-qr-block" id="invoiceQrTarget" style="width:80px; height:80px;"></div>
            </div>
            <div class="inv-body">
                <div class="inv-title-section">
                    <h1>Invoice</h1>
                    <span class="inv-badge">#${order.id}</span>
                </div>

                <div class="two-col">
                    <div class="col-bill">
                        <h4>BILL TO</h4>
                        <p>${order.customer}</p>
                        <p>${order.address}</p>
                        <p>ðŸ“ž ${order.mobile}</p>
                    </div>
                    <div class="col-bill">
                        <h4>INVOICE DATE</h4>
                        <p>${order.date}</p>
                        <h4 style="margin-top:10px;">PAYMENT</h4>
                        <p>${order.method}</p>
                    </div>
                </div>

                <div class="delivery-chip">
                    <i class="fas fa-leaf"></i>
                    <span>Estimated delivery: ${deliveryStr}</span>
                </div>

                <table class="inv-table-mini">
                    <thead><tr><th>Item</th><th>Rate</th><th>Qty</th><th>Amount</th></tr></thead>
                    <tbody>
                        ${order.items.map(it => `<tr><td>${it.name}</td><td>â‚¹${it.price}</td><td>${it.quantity}</td><td>â‚¹${it.price * it.quantity}</td></tr>`).join('')}
                    </tbody>
                </table>

                <div class="invoice-total-card">
                    <div class="total-row"><span>Subtotal</span><span>â‚¹${subtotal}</span></div>
                    <div class="total-row"><span>Tax (12%)</span><span>â‚¹${tax}</span></div>
                    <div class="total-row grand-total"><span>Total</span><span>â‚¹${grandTotal}</span></div>
                </div>

                <div class="inv-footer-note">
                    <div><i class="fas fa-seedling"></i> UPI / Card</div>
                    <div><button class="btn btn-primary" style="padding:8px 24px;" onclick="downloadInvoicePDF('${order.id}')"><i class="fas fa-download"></i> Download PDF</button></div>
                </div>
            </div>
        `;

        // QR code
        setTimeout(() => {
            const qrDiv = document.getElementById('invoiceQrTarget');
            qrDiv.innerHTML = '';
            if (window.QRCode) {
                new QRCode(qrDiv, {
                    text: `upi://pay?pa=moderngarden@okhdfcbank&pn=ModernGarden&am=${grandTotal}&cu=INR`,
                    width: 70,
                    height: 70,
                    colorDark: '#1a3b2e',
                    colorLight: '#f9fff9'
                });
            } else {
                qrDiv.innerHTML = '<span style="font-size:9px;">QR error</span>';
            }
        }, 50);

        document.getElementById('invoiceModal').style.display = 'flex';
    };

    // ----- DOWNLOAD PDF (FIXED & FULLY WORKING) -----
    window.downloadInvoicePDF = function(orderId) {
        console.log('Downloading invoice for order:', orderId);
        
        const orders = JSON.parse(localStorage.getItem('orders'));
        const order = orders.find(o => o.id === orderId);
        
        if (!order) {
            showToast('Order not found');
            return;
        }

        if (!window.jspdf) {
            showToast('PDF library not loaded');
            return;
        }

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const subtotal = order.items.reduce((a, i) => a + (i.price * i.quantity), 0);
            const tax = Math.round(subtotal * 0.12);
            const total = subtotal + tax;

            // Header with green background
            doc.setFillColor(26, 59, 46);
            doc.rect(0, 0, 220, 35, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('Modern Garden', 20, 22);
            doc.setFontSize(8);
            doc.text('INVOICE Â· heirloom plants', 20, 30);

            // Invoice details
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.text(`Invoice #${order.id}`, 150, 25);
            doc.setFontSize(10);
            doc.text(`Date: ${order.date}`, 150, 32);

            // Bill to
            doc.setFontSize(11);
            doc.text(`Bill to: ${order.customer}`, 20, 50);
            doc.setFontSize(9);
            doc.text(order.address, 20, 57);
            doc.text(`Phone: ${order.mobile}`, 20, 64);

            // delivery
            const parts = order.date.split('/');
            const d = new Date(`${parts[1]}/${parts[0]}/${parts[2]}`);
            d.setDate(d.getDate() + 5);
            const deliv = d.toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' });
            doc.setTextColor(46, 125, 50);
            doc.text(`Est. delivery: ${deliv}`, 20, 74);
            doc.setTextColor(0, 0, 0);

            // table header
            let y = 88;
            doc.setFillColor(225, 240, 225);
            doc.rect(20, y-5, 170, 8, 'F');
            doc.setFont('helvetica', 'bold');
            doc.text('Item', 22, y);
            doc.text('Price', 100, y);
            doc.text('Qty', 135, y);
            doc.text('Total', 165, y);
            doc.setFont('helvetica', 'normal');
            y += 8;

            order.items.forEach(it => {
                doc.text(it.name.substring(0,18), 22, y);
                doc.text(`â‚¹${it.price}`, 100, y);
                doc.text(String(it.quantity), 135, y);
                doc.text(`â‚¹${it.price * it.quantity}`, 165, y);
                y += 8;
            });

            y += 8;
            doc.text(`Subtotal: â‚¹${subtotal}`, 130, y);
            y += 6;
            doc.text(`Tax (12%): â‚¹${tax}`, 130, y);
            y += 8;
            doc.setFont('helvetica', 'bold');
            doc.text(`TOTAL: â‚¹${total}`, 130, y);

            // Footer
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text('Thank you for supporting Modern Garden!', 70, 270);
            doc.text('Terms: Live plants replaced if damaged.', 60, 277);

            // Save the PDF
            doc.save(`Invoice_${order.id}.pdf`);
            showToast(`âœ… PDF downloaded: Invoice_${order.id}.pdf`);
            
            // Keep modal open
        } catch (error) {
            console.error('PDF generation error:', error);
            showToast('Error generating PDF. Check console.');
        }
    };

    // close modal when clicking outside
    document.querySelectorAll('.modal').forEach(m => {
        m.addEventListener('click', (e) => {
            if (e.target === m) m.style.display = 'none';
        });
    });

    // initial render
    renderOrders();
</script>
</body>
</html>
